<template>
  <div
    class="ui-scale"
    role="radiogroup"
    :aria-label="defaultProps.translation.label"
  >
    <component
      :is="tag"
      class="ui-scale__controls"
    >
      <!-- @slot Use this slot to replace legend template. -->
      <slot
        name="legend"
        v-bind="{ legend }"
      >
        <legend
          v-if="legend"
          class="visual-hidden"
        >
          {{ legend }}
        </legend>
      </slot>
      <template
        v-for="(item, index) in itemsToRender"
        :key="index"
      >
        <UiRadio
          ref="optionRefs"
          v-bind="item"
          v-model="scaleValue"
          :value="index"
          class="ui-scale__option"
          :aria-labelledby="`scale-label-${index}`"
          @mouseover="hoverHandler($event, index)"
          @mouseleave="hoverHandler($event, index)"
        >
          <template
            #radio="{ radioElementAttrs }"
          >
            <div
              v-bind="radioElementAttrs"
              :style="calcActiveElementOpacity(index)"
              :class="[
                'ui-scale__square', { 'ui-scale__square--is-checked': index <= finalValue, }
              ]"
            />
          </template>
          <template
            #label="{ textLabelAttrs }"
          >
            <UiText
              :id="`scale-label-${index}`"
              v-bind="textLabelAttrs"
              :class="[
                'ui-scale__label', { 'ui-scale__label--is-checked': index === scaleValue, }
              ]"
            >
              {{ index + 1 }}
            </UiText>
          </template>
        </UiRadio>
      </template>
    </component>
    <!-- @slot Use this slot to replace description template. -->
    <slot
      name="description"
      v-bind="{
        translation: defaultProps.translation,
        textMinAttrs,
        textMaxAttrs
      }"
    >
      <div class="ui-scale__description">
        <!-- @slot Use this slot to replace min template. -->
        <slot
          name="min"
          v-bind="{
            textMinAttrs,
            translation: defaultProps.translation
          }"
        >
          <UiText
            v-bind="textMinAttrs"
            class="ui-scale__min"
            aria-hidden="true"
          >
            {{ defaultProps.translation.min }}
          </UiText>
        </slot>
        <!-- @slot Use this slot to replace max template. -->
        <slot
          name="max"
          v-bind="{
            textMaxAttrs,
            translation: defaultProps.translation
          }"
        >
          <UiText
            v-bind="textMaxAttrs"
            class="ui-scale__max"
            aria-hidden="true"
          >
            {{ defaultProps.translation.max }}
          </UiText>
        </slot>
      </div>
    </slot>
    <!-- @slot Use this slot to replace mobile controls template. -->
    <slot
      name="mobile-controls"
      v-bind="{
        numberStepperAttrs: defaultProps.numberStepperAttrs,
        scaleValue,
        steps,
        max: steps - 1,
        changeHandler
      }"
    >
      <UiNumberStepper
        v-bind="defaultProps.numberStepperAttrs"
        class="ui-scale__mobile-controls"
        :model-value="scaleValue"
        :min="0"
        :max="steps - 1"
        @update:model-value="changeHandler"
      >
        <template
          v-for="(_, slotName) in $slots"
          #[slotName]="data"
        >
          <slot
            :name="slotName"
            v-bind="data"
          />
        </template>
      </UiNumberStepper>
    </slot>
  </div>
</template>

<script setup lang="ts">
import {
  computed,
  ref,
  watch,
} from 'vue';
import type {
  CSSProperties,
  ComponentPublicInstance,
} from 'vue';
import { uid } from 'uid/single';
import UiRadio from '../../atoms/UiRadio/UiRadio.vue';
import type { RadioAttrsProps } from '../../atoms/UiRadio/UiRadio.vue';
import UiText from '../../atoms/UiText/UiText.vue';
import type { TextAttrsProps } from '../../atoms/UiText/UiText.vue';
import UiNumberStepper from '../UiNumberStepper/UiNumberStepper.vue';
import type { NumberStepperAttrsProps } from '../UiNumberStepper/UiNumberStepper.vue';
import { focusElement } from '../../../utilities/helpers/index';
import type {
  DefineAttrsProps,
  HTMLTag,
} from '../../../types';

export interface ScaleTranslation {
  label?: string;
  min?: string;
  max?: string;
}
export type ScaleValue = number;
export interface ScaleProps {
  /**
   * Use this props or v-model to set value.
   */
  modelValue?: ScaleValue;
  /**
   * Use this props to set scale name.
   * Default value is generated by uid i.e. `scale-<uid>`.
   */
  name?: string;
  /**
   * Use this props to set max value
   */
  steps?: number;
  /**
   * Use this props to override labels inside component translation.
   */
  translation?: ScaleTranslation;
  /**
   * Use this props to set scale tag.
   */
  tag?: HTMLTag;
  /**
   * Use this props to set legend.
   */
  legend?: string;
  /**
   * Use this props to pass attrs for option UiRadio.
   */
  radioOptionAttrs?: RadioAttrsProps | RadioAttrsProps[];
  /**
   * USe this props to pass attrs for min UiText.
   */
  textMinAttrs?: TextAttrsProps;
  /**
   * USe this props to pass attrs for max UiText.
   */
  textMaxAttrs?: TextAttrsProps;
  /**
   * USe this props to pass attrs for UiNumberStepper.
   */
  numberStepperAttrs?: NumberStepperAttrsProps;
}
export type ScaleAttrsProps = DefineAttrsProps<ScaleProps>
export interface ScaleEmits {
  (e: 'update:modelValue', value: ScaleValue): void;
}

const props = withDefaults(defineProps<ScaleProps>(), {
  modelValue: 0,
  name: '',
  steps: 10,
  translation: () => ({
    label: 'Pain scale',
    min: 'Mild',
    max: 'Unbearable',
  }),
  tag: 'fieldset',
  legend: '',
  radioOptionAttrs: () => ([]),
  textMinAttrs: () => ({}),
  textMaxAttrs: () => ({}),
  numberStepperAttrs: () => ({}),
});
const emit = defineEmits<ScaleEmits>();
const scaleName = computed(() => (
  props.name || `scale-${uid()}`
));
const optionRefs = ref<ComponentPublicInstance[]>([]);
const maxSteps = computed(() => props.steps);
const valueValidation = (value: ScaleValue) => value >= 0 && value < maxSteps.value;
const changeHandler = (value: ScaleValue) => {
  if (valueValidation(value)) {
    emit('update:modelValue', value);
  }
};
const scaleValue = computed<ScaleValue>({
  get: () => props.modelValue,
  set: (value) => {
    changeHandler(value);
  },
});
const hoverValue = ref(-1);
const hoverHandler = ({ type }: Event, value: number) => {
  hoverValue.value = type === 'mouseover' ? value : -1;
};
const finalValue = computed<ScaleValue>(() => (hoverValue.value >= 0 ? hoverValue.value : scaleValue.value));
watch(finalValue, (value: ScaleValue) => {
  focusElement(optionRefs.value[value].$el, true);
});
const calcActiveElementOpacity = (index: number): CSSProperties => {
  const opacityStepValue = 1 / (maxSteps.value - 1);
  const isActive = index <= finalValue.value;

  return isActive ? { '--_scale-square-overlay-opacity': (index * opacityStepValue).toFixed(3) } : {};
};
const defaultProps = computed(() => ({
  translation: {
    label: 'Pain scale',
    min: 'Mild',
    max: 'Unbearable',
    ...props.translation,
  },
  numberStepperAttrs: { ...props.numberStepperAttrs },
}));
const itemsToRender = computed<RadioAttrsProps[]>(() => (Array.from({ length: maxSteps.value }, (_, index) => {
  const radioOptionAttrs = Array.isArray(props.radioOptionAttrs)
    ? props.radioOptionAttrs[index]
    : props.radioOptionAttrs;
  return {
    ...radioOptionAttrs,
    textLabelAttrs: {
      tag: 'div',
      ...radioOptionAttrs?.textLabelAttrs,
    },
    inputAttrs: {
      name: scaleName.value,
      ...radioOptionAttrs?.inputAttrs,
    },
  };
})));
</script>

<style lang="scss">
@use "../../../styles/functions";
@use "../../../styles/mixins";

.ui-scale {
  $this: &;
  $element: scale;

  --radio-gap: #{functions.var($element + "-option", gap, var(--space-8))};

  &__controls {
    @at-root fieldset#{&} {
      padding: 0;
      border: none;
      margin: 0;
    }

    display: flex;
    gap: functions.var($element + "-controls", gap, 1px);
  }

  &__mobile-controls {
    @include mixins.use-logical($element + "-mobile-controls", margin, var(--space-32) 0 0 0);

    @include mixins.from-tablet {
      display: none;
    }
  }

  &__option {
    @include mixins.use-logical($element + "-option", border-width, 0);
    @include mixins.use-logical($element + "-option", border-radius, var(--border-radius-form));

    position: relative;
    flex: 1;
    flex-direction: column-reverse;
    align-items: center;

    &:first-of-type {
      #{$this}__square {
        @include mixins.use-logical(
          $element + "-option",
          border-radius,
          var(--border-radius-form) 0 var(--border-radius-form) 0
        );
      }
    }

    &:last-of-type {
      #{$this}__square {
        @include mixins.use-logical(
          $element + "-option",
          border-radius,
          0 var(--border-radius-form) 0 var(--border-radius-form)
        );
      }
    }

    &::after {
      @include mixins.use-logical($element + "-option", border-radius, inherit);

      position: absolute;
      z-index: 1;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      box-shadow: var(--focus-outer);
      content: "";
      opacity: 0;
      pointer-events: none;
    }

    @include mixins.with-focus {
      &:focus-within {
        &::after {
          opacity: 1;
        }
      }
    }
  }

  &__square {
    position: relative;
    width: 100%;
    flex: 1 1 functions.var($element + "-square", height, 2.5rem);
    background: functions.var($element + "-square", background, var(--color-dataviz-diverging-track));

    &::after {
      @include mixins.use-logical($element + "-square", border-radius, inherit);

      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      background:
        functions.var(
          $element + "-square-overlay",
          background,
          var(--color-dataviz-diverging-strongly-negative)
        );
      content: "";
      opacity: var(--_scale-square-overlay-opacity, 0);
      transition: opacity 150ms ease-in-out;
    }

    &--is-checked {
      background:
        functions.var(
          $element + "-square",
          background,
          var(--color-dataviz-diverging-moderately-negative)
        );
    }
  }

  &__label {
    --text-color: #{functions.var($element + "-label", color, var(--color-text-body))};

    @include mixins.use-logical($element + "-label", padding, var(--space-8) 0);
    @include mixins.use-logical($element + "-label", border-radius, inherit);

    position: relative;
    width: 100%;
    text-align: center;

    &::after {
      position: absolute;
      bottom: 0;
      left: 50%;
      width: functions.var($element + "-label-arrow", size, 8px);
      height: functions.var($element + "-label-arrow", size, 8px);
      background: inherit;
      content: "";
      transform: translate(-50%, 50%) rotate(45deg) scale(#{"calc(8 / 11.31)"});
    }

    &--is-checked {
      --text-color: #{functions.var($element + "-label", color, var(--color-text-on-selection))};

      background: functions.var($element + "-checked-label", background, var(--color-background-selection));
    }
  }

  &__description {
    --_scale-description-color: #{functions.var($element + "-description", color, var(--color-text-dimmed))};

    @include mixins.use-logical($element + "-description", margin, var(--space-16) 0 0 0);

    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  &__min {
    --text-color: #{functions.var($element + "-min", color, var(--_scale-description-color))};
  }

  &__max {
    --text-color: #{functions.var($element + "-max", color, var(--_scale-description-color))};
  }
}
</style>

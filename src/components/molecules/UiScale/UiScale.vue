<template>
  <div
    class="ui-scale"
    role="radiogroup"
    :aria-label="defaultProps.translation.label"
  >
    <component
      :is="tag"
      class="ui-scale__controls"
    >
      <!-- @slot Use this slot to replace legend template. -->
      <slot
        name="legend"
        v-bind="{ legend }"
      >
        <legend
          v-if="legend"
          class="visual-hidden"
        >
          {{ legend }}
        </legend>
      </slot>
      <template
        v-for="(item, index) in itemsToRender"
        :key="index"
      >
        <UiRadio
          ref="optionRefs"
          v-bind="item"
          v-model="scaleValue"
          :value="index"
          :name="scaleName"
          class="ui-scale__option"
          :aria-labelledby="`scale-label-${index}`"
          @mouseover="hoverHandler($event, index)"
          @mouseleave="hoverHandler($event, index)"
        >
          <template
            #radio="{ radioElementAttrs }"
          >
            <div
              v-bind="radioElementAttrs"
              :style="calcActiveElementOpacity(index)"
              :class="[
                'ui-scale__square', { 'ui-scale__square--is-checked': index <= finalValue, }
              ]"
            />
          </template>
          <template
            #label="{ textLabelAttrs }"
          >
            <UiText
              :id="`scale-label-${index}`"
              v-bind="textLabelAttrs"
              :class="[
                'ui-scale__label', { 'ui-scale__label--is-checked': index === scaleValue, }
              ]"
            >
              {{ index + 1 }}
            </UiText>
          </template>
        </UiRadio>
      </template>
    </component>
    <!-- @slot Use this slot to replace description template. -->
    <slot
      name="description"
      v-bind="{
        translation: defaultProps.translation,
        textMinAttrs,
        textMaxAttrs
      }"
    >
      <div class="ui-scale__description">
        <!-- @slot Use this slot to replace min template. -->
        <slot
          name="min"
          v-bind="{
            textMinAttrs,
            translation: defaultProps.translation
          }"
        >
          <UiText
            v-bind="textMinAttrs"
            class="ui-scale__min"
            aria-hidden="true"
          >
            {{ defaultProps.translation.min }}
          </UiText>
        </slot>
        <!-- @slot Use this slot to replace max template. -->
        <slot
          name="max"
          v-bind="{
            textMaxAttrs,
            translation: defaultProps.translation
          }"
        >
          <UiText
            v-bind="textMaxAttrs"
            class="ui-scale__max"
            aria-hidden="true"
          >
            {{ defaultProps.translation.max }}
          </UiText>
        </slot>
      </div>
    </slot>
    <!-- @slot Use this slot to replace mobile controls template. -->
    <slot
      name="mobile-controls"
      v-bind="{
        numberStepperAttrs: defaultProps.numberStepperAttrs,
        scaleValue,
        steps,
        max: steps - 1,
        changeHandler
      }"
    >
      <UiNumberStepper
        v-bind="defaultProps.numberStepperAttrs"
        class="ui-scale__mobile-controls"
        :model-value="scaleValue"
        :min="0"
        :max="steps - 1"
        @update:model-value="changeHandler"
      >
        <template
          v-for="(_, slotName) in $slots"
          #[slotName]="data"
        >
          <slot
            :name="slotName"
            v-bind="data"
          />
        </template>
      </UiNumberStepper>
    </slot>
  </div>
</template>

<script setup lang="ts">
import {
  computed,
  ref,
  useAttrs,
  watch,
} from 'vue';
import type {
  CSSProperties,
  PropType,
  ComponentPublicInstance,
} from 'vue';
import { uid } from 'uid/single';
import UiRadio from '../../atoms/UiRadio/UiRadio.vue';
import UiText from '../../atoms/UiText/UiText.vue';
import UiNumberStepper from '../UiNumberStepper/UiNumberStepper.vue';
import type { PropsAttrs } from '../../../types/attrs';
import { focusElement } from '../../../utilities/helpers/index';
import type { HTMLTag } from '../../../types/tag';

export interface ScaleTranslation {
  label?: string;
  min?: string;
  max?: string;
  [key: string]: string | undefined;
}
const props = defineProps({
  /**
   * Use this props or v-model to set value.
   */
  modelValue: {
    type: Number,
    default: null,
  },
  /**
   * Use this props to set scale name.
   * Default value is generated by uid i.e. `scale-<uid>`.
   */
  name: {
    type: String,
    default: '',
  },
  /**
   * Use this props to set max value
   */
  steps: {
    type: Number,
    default: 10,
    validator: (value: number) => value > 0,
  },
  /**
   * Use this props to override labels inside component translation.
   */
  translation: {
    type: Object as PropType<ScaleTranslation>,
    default: () => ({
      label: 'Pain scale',
      min: 'Mild',
      max: 'Unbearable',
    }),
  },
  /**
   * Use this props to set scale tag.
   */
  tag: {
    type: String as PropType<HTMLTag>,
    default: 'fieldset',
  },
  /**
   * Use this props to set legend.
   */
  legend: {
    type: String,
    default: '',
  },
  /**
   * Use this props to pass attrs for option UiRadio.
   */
  radioOptionAttrs: {
    type: [
      Object,
      Array,
    ] as PropType<Record<string, unknown> | Record<string, unknown>[]>,
    default: () => ({}),
  },
  /**
   * USe this props to pass attrs for min UiText.
   */
  textMinAttrs: {
    type: Object as PropsAttrs,
    default: () => ({}),
  },
  /**
   * USe this props to pass attrs for max UiText.
   */
  textMaxAttrs: {
    type: Object as PropsAttrs,
    default: () => ({}),
  },
  /**
   * USe this props to pass attrs for UiNumberStepper.
   */
  numberStepperAttrs: {
    type: Object as PropsAttrs,
    default: () => ({}),
  },
});
const emit = defineEmits<{(e: 'update:modelValue', value: number): void}>();
const scaleName = computed(() => (
  props.name || `scale-${uid()}`
));
const optionRefs = ref<ComponentPublicInstance[]>([]);
const maxSteps = computed(() => props.steps);
function valueValidation(value: number): boolean {
  return value >= 0 && value < maxSteps.value;
}
function changeHandler(value: number, modifier = 0): void {
  const newValue = value + modifier;
  if (valueValidation(newValue)) {
    emit('update:modelValue', newValue);
  }
}
const scaleValue = computed({
  get: (): number => props.modelValue,
  set: (value: number): void => {
    changeHandler(value);
  },
});
const hoverValue = ref(-1);
function hoverHandler({ type }: {type: string}, value: number): void {
  hoverValue.value = type === 'mouseover' ? value : -1;
}
const finalValue = computed(() => (hoverValue.value >= 0 ? hoverValue.value : scaleValue.value));
watch(finalValue, (value: number) => {
  focusElement(optionRefs.value[value]?.$el, true);
});
function calcActiveElementOpacity(index: number): CSSProperties {
  const opacityStepValue = 1 / (maxSteps.value - 1);
  const isActive = index <= finalValue.value;

  return isActive ? { '--_scale-square-overlay-opacity': (index * opacityStepValue).toFixed(3) } : {};
}
// TODO: remove in 0.6.0 / BEGIN
const attrs = useAttrs();
const buttonDecrementAttrs = computed(() => attrs.buttonDecrementAttrs || attrs['button-decrement-attrs']);
if (buttonDecrementAttrs.value) {
  if (process.env.NODE_ENV === 'development') {
    console.warn('[@infermedica/component-library warn][UiScale]: The `buttonDecrementAttrs` props will be removed in 0.6.0. Please use `numberStepperAttrs` props instead.');
  }
}
const buttonIncrementAttrs = computed(() => attrs.buttonIncrementAttrs || attrs['button-increment-attrs']);
if (buttonIncrementAttrs.value) {
  if (process.env.NODE_ENV === 'development') {
    console.warn('[@infermedica/component-library warn][UiScale]: The `buttonIncrementAttrs` will be removed in 0.6.0. Please use `numberStepperAttrs` props instead.');
  }
}
const translationMild = computed(() => props.translation?.mild);
if (translationMild.value) {
  if (process.env.NODE_ENV === 'development') {
    console.warn('[@infermedica/component-library warn][UiScale]: The translation `mild` will be removed in 0.6.0. Please use `min` translation property instead.');
  }
}
const translationUnbearable = computed(() => props.translation?.mild);
if (translationUnbearable.value) {
  if (process.env.NODE_ENV === 'development') {
    console.warn('[@infermedica/component-library warn][UiScale]: The translation `unbearable` will be removed in 0.6.0. Please use `max` translation property instead.');
  }
}
// END
interface DefaultProps {
  translation: ScaleTranslation;
  numberStepperAttrs: Record<string, unknown>;
}
const defaultProps = computed<DefaultProps>(() => ({
  translation: {
    label: 'Pain scale',
    min: props.translation?.mild || 'Mild',
    max: props.translation?.unbearable || 'Unbearable',
    ...props.translation,
  },
  numberStepperAttrs: {
    buttonDecrementAttrs: buttonDecrementAttrs.value,
    buttonIncrementAttrs: buttonIncrementAttrs.value,
    ...props.numberStepperAttrs,
  },
}));
const itemsToRender = computed(() => (Array.from({ length: maxSteps.value }, (_, index) => {
  const radioOptionAttrs:Record<string, unknown> = Array.isArray(props.radioOptionAttrs)
    ? props.radioOptionAttrs[index]
    : props.radioOptionAttrs;
  return {
    ...radioOptionAttrs,
    // eslint-disable-next-line prefer-object-spread
    textLabelAttrs: Object.assign({ tag: 'div' }, radioOptionAttrs?.textLabelAttrs), // fix: Spread types may only be created from object types. Object.assign ignored undefined types.
  };
})));
</script>

<style lang="scss">
@use "../../../styles/functions";
@use "../../../styles/mixins";

.ui-scale {
  $this: &;
  $element: scale;

  --radio-gap: #{functions.var($element + "-option", gap, var(--space-8))};

  &__controls {
    @at-root fieldset#{&} {
      padding: 0;
      border: none;
      margin: 0;
    }

    display: flex;
  }

  &__mobile-controls {
    @include mixins.use-logical($element + "-mobile-controls", margin, var(--space-32) 0 0 0);

    @include mixins.from-tablet {
      display: none;
    }
  }

  &__option {

    --_scale-option-gap: #{functions.var($element + "-option", gap, 1px)};

    @include mixins.use-logical($element + "-option", border-style, solid);
    @include mixins.use-logical($element + "-option", border-color, transparent);
    @include mixins.use-logical($element + "-option", border-width, 0 var(--_scale-option-gap) 0 0);
    @include mixins.use-logical($element + "-option", border-radius, var(--border-radius-form));

    position: relative;
    flex: 1;
    flex-direction: column-reverse;
    align-items: center;

    &:first-of-type {
      #{$this}__square {
        @include mixins.use-logical(
          $element + "-option",
          border-radius,
          var(--border-radius-form) 0 var(--border-radius-form) 0
        );
      }
    }

    &:last-of-type {
      --scale-option-gap: 0;

      #{$this}__square {
        @include mixins.use-logical(
          $element + "-option",
          border-radius,
          0 var(--border-radius-form) 0 var(--border-radius-form)
        );
      }
    }

    &::after {
      @include mixins.use-logical($element + "-option", border-radius, inherit);

      position: absolute;
      z-index: 1;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      box-shadow: var(--focus-outer);
      content: "";
      opacity: 0;
      pointer-events: none;
    }

    @include mixins.with-focus {
      &:focus-within {
        &::after {
          opacity: 1;
        }
      }
    }
  }

  &__square {
    position: relative;
    width: 100%;
    flex: 1 1 functions.var($element + "-square", height, 2.5rem);
    background: functions.var($element + "-square", background, var(--color-dataviz-diverging-track));

    &::after {
      @include mixins.use-logical($element + "-square", border-radius, inherit);

      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      background:
        functions.var(
          $element + "-square-overlay",
          background,
          var(--color-dataviz-diverging-strongly-negative)
        );
      content: "";
      opacity: var(--_scale-square-overlay-opacity, 0);
      transition: opacity 150ms ease-in-out;
    }

    &--is-checked {
      background:
        functions.var(
          $element + "-square",
          background,
          var(--color-dataviz-diverging-moderately-negative)
        );
    }
  }

  &__label {
    --text-color: #{functions.var($element + "-label", color, var(--color-text-body))};

    @include mixins.use-logical($element + "-label", padding, var(--space-8) 0);
    @include mixins.use-logical($element + "-label", border-radius, inherit);

    position: relative;
    width: 100%;
    text-align: center;

    &::after {
      position: absolute;
      bottom: 0;
      left: 50%;
      width: functions.var($element + "-label-arrow", size, 8px);
      height: functions.var($element + "-label-arrow", size, 8px);
      background: inherit;
      content: "";
      transform: translate(-50%, 50%) rotate(45deg) scale(#{"calc(8 / 11.31)"});
    }

    &--is-checked {
      --text-color: #{functions.var($element + "-label", color, var(--color-text-on-selection))};

      background: functions.var($element + "-checked-label", background, var(--color-background-selection));
    }
  }

  &__description {
    --_scale-description-color: #{functions.var($element + "-description", color, var(--color-text-dimmed))};

    @include mixins.use-logical($element + "-description", margin, var(--space-16) 0 0 0);

    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  &__min {
    --text-color: #{functions.var($element + "-mild", color, var(--_scale-description-color))};
  }

  &__max {
    --text-color: #{functions.var($element + "-unbearable", color, var(--_scale-description-color))};
  }
}
</style>

<template>
  <component
    :is="tag"
    class="ui-rating"
  >
    <!-- @slot Use this slot to replace legend template. -->
    <slot
      name="legend"
      v-bind="{ legend }"
    >
      <legend
        v-if="legend"
        class="visual-hidden"
      >
        {{ legend }}
      </legend>
    </slot>
    <template
      v-for="(item, index) in itemsToRender"
      :key="index"
    >
      <!-- @slot Use this slot to replace option template. -->
      <slot
        name="option"
        v-bind="{
          index: item.index,
          rate,
          radioAttrs,
          ratingName,
          hoverHandler,
          finalScore,
          settings,
          translation: defaultProps.translation
        }"
      >
        <UiRadio
          v-model="rate"
          v-bind="ratingItemAttrs(item)"
          :value="`${item.index}`"
          :name="ratingName"
          class="ui-rating__option"
          @mouseover="hoverHandler($event, item.index)"
          @mouseleave="hoverHandler($event, item.index)"
        >
          <template
            #radio="{ radioElementAttrs }"
          >
            <div
              v-bind="radioElementAttrs"
              :class="[
                'ui-rating__radio',{ 'ui-rating__radio--is-checked': item.index <= finalScore }
              ]"
            >
              <!-- @slot Use this slot to replace rating icon. -->
              <slot
                name="icon"
                v-bind="{
                  index: item.index,
                  finalScore,
                  iconActiveAttrs: item.iconActiveAttrs,
                  iconDefaultAttrs: item.iconDefaultAttrs,
                }"
              >
                <template v-if="item.index <= finalScore">
                  <!-- @slot Use this slot to replace active rating icon. -->
                  <slot
                    name="icon-active"
                    v-bind="{ iconActiveAttrs: item.iconActiveAttrs }"
                  >
                    <UiIcon
                      v-bind="item.iconActiveAttrs"
                      class="ui-rating__icon"
                    />
                  </slot>
                </template>
                <template v-else>
                  <!-- @slot Use this slot to replace default rating icon. -->
                  <slot
                    name="icon-default"
                    v-bind="{ iconDefaultAttrs: item.iconDefaultAttrs }"
                  >
                    <UiIcon
                      v-bind="item.iconDefaultAttrs"
                      class="ui-rating__icon"
                    />
                  </slot>
                </template>
              </slot>
            </div>
          </template>
          <template
            #label="{ textLabelAttrs }"
          >
            <span
              v-bind="textLabelAttrs"
              class="visual-hidden"
            >{{ defaultProps.translation.stars(index) }}</span>
          </template>
        </UiRadio>
      </slot>
    </template>
  </component>
</template>

<script setup lang="ts">
import {
  computed,
  ref,
  useAttrs,
  useSlots,
} from 'vue';
import type { PropType } from 'vue';
import { uid } from 'uid/single';
import UiRadio from '../../atoms/UiRadio/UiRadio.vue';
import UiIcon from '../../atoms/UiIcon/UiIcon.vue';
import type { Icon } from '../../../types/icon';
import type { HTMLTag } from '../../../types/tag';

export type RatingValue = string | number;
export interface RatingSettings {
  iconDefault: Icon;
  iconActive: Icon;
  [key: string]: unknown
}
export interface RatingTranslation {
  stars: (index: number) => string;
  [key: string]: unknown;
}
const props = defineProps({
  /**
   * Use this props to set current rate.
   */
  modelValue: {
    type: [
      String,
      Number,
    ] as PropType<RatingValue>,
    default: 0,
  },
  /**
   * Use this props to set max rate
   */
  max: {
    type: [
      String,
      Number,
    ] as PropType<RatingValue>,
    default: 1,
  },
  /**
   * Use this props to set rating name.
   * Default value is generated by uid i.e. `rating-<uid>`.
   */
  name: {
    type: String,
    default: '',
  },
  /**
   * Use this props to setup item component.
   */
  settings: {
    type: Object as PropType<RatingSettings>,
    default: () => ({
      iconDefault: 'star-outlined',
      iconActive: 'star-filled',
    }),
  },
  /**
   * Use this props to override labels inside component translation.
   */
  translation: {
    type: Object as PropType<RatingTranslation>,
    default: () => ({ stars: (index: number) => (`${index} stars`) }),
  },
  /**
   * Use this props to set rating tag.
   */
  tag: {
    type: String as PropType<HTMLTag>,
    default: 'fieldset',
  },
  /**
   * Use this props to set legend.
   */
  legend: {
    type: String,
    default: '',
  },
  /**
   * Use this props to pass attrs for option UiRadio.
   */
  radioOptionAttrs: {
    type: [
      Object,
      Array,
    ],
    default: () => ({}),
  },
});
const defaultProps = computed(() => ({
  translation: { stars: (index: number) => (`${index} stars`) },
  settings: {
    ...{
      iconDefault: 'star-outlined',
      iconActive: 'star-filled',
    },
    ...props.settings,
  },
}));
const emit = defineEmits<{(e:'update:modelValue', value: string): void}>();
const ratingName = computed(() => (
  props.name || `rating-${uid()}`
));
const rate = computed({
  get: (): string => (`${props.modelValue}`),
  set: (value: string): void => { emit('update:modelValue', value); },
});
const maxScore = computed(() => (typeof props.max === 'number' ? props.max : parseInt(props.max, 10)));
const hoverScore = ref(0);
function hoverHandler(event: Event, value: number) {
  const { type } = event;
  hoverScore.value = type === 'mouseover' ? value : 0;
}
const finalScore = computed(() => (
  hoverScore.value
    ? hoverScore.value
    : parseInt(rate.value, 10)));
// TODO: remove in 0.6.0 / BEGIN
const attrs = useAttrs();
const radioAttrs = computed(() => (attrs.radioAttrs || attrs['radio-attrs']));
if (radioAttrs.value) {
  if (process.env.NODE_ENV === 'development') {
    console.warn('[@infermedica/component-library warn][UiRating]: The `radioAttrs` props will be removed in 0.6.0. Please use `radioOptionAttrs` props instead.');
  }
}
const icon = computed(() => (props.settings.icon));
if (icon.value) {
  if (process.env.NODE_ENV === 'development') {
    console.warn('[@infermedica/component-library warn][UiRating]: The `icon` property from `settings` props will be removed in 0.6.0. Please use `iconDefault` property instead.');
  }
}
const slots = useSlots();
const iconSlot = computed(() => (slots.icon));
if (iconSlot.value) {
  if (process.env.NODE_ENV === 'development') {
    console.warn('[@infermedica/component-library error][UiRating]: From 0.5.2 `icon` slot is use to replace template of rating icons. Please use `iconDefault` slot instead.');
  }
}
// END
const itemsToRender = computed(() => (Array.from({ length: maxScore.value }, (_, index) => {
  const proxyRadioAttrs = radioAttrs.value || props.radioOptionAttrs; // TODO: remove proxy in 0.6.0
  const radioOptionAttrs = Array.isArray(proxyRadioAttrs)
    ? proxyRadioAttrs[index]
    : proxyRadioAttrs;
  return {
    index: index + 1,
    ...radioOptionAttrs,
    iconActiveAttrs: {
      icon: defaultProps.value.settings.iconActive,
      ...radioOptionAttrs?.iconActiveAttrs,
    },
    iconDefaultAttrs: {
      icon: icon.value || defaultProps.value.settings.iconDefault, // TODO: remove icon.value in 0.6.0
      ...radioOptionAttrs?.iconDefaultAttrs,
    },
    textLabelAttrs: {
      tag: 'div',
      ...radioOptionAttrs?.textLabelAttrs,
    },
  };
})));
const ratingItemAttrs = (item: Record<string, unknown>) => {
  const {
    iconActiveAttrs, iconDefaultAttrs, index, ...rest
  } = item;
  return rest;
};
</script>

<style lang="scss">
@use "../../../styles/functions";
@use "../../../styles/mixins";

.ui-rating {
  $this: &;
  $element: rating;

  @at-root fieldset#{&} {
    padding: 0;
    border: none;
    margin: 0;
  }

  display: flex;
  align-items: center;
  justify-content: flex-start;

  &__option {
    --_rating-option-gap: #{functions.var($element + "-option", gap, var(--space-24))};

    position: relative;
    border: solid transparent;
    border-width: 0 var(--_rating-option-gap) 0 0;

    @include mixins.hover {
      #{$this}__icon {
        --icon-color: #{functions.var($element + "-hover-icon", color, var(--color-icon-secondary-hover))};
      }

      #{$this}__radio {
        &--is-checked {
          #{$this}__icon {
            --icon-color: #{functions.var($element + "-checked-hover-icon", color, var(--color-icon-primary-hover))};
          }
        }
      }
    }

    &:active {
      #{$this}__icon {
        --icon-color: #{functions.var($element + "-active-icon", color, var(--color-icon-secondary-active))};
      }

      #{$this}__radio {
        &--is-checked {
          #{$this}__icon {
            --icon-color: #{functions.var($element + "-checked-active-icon", color, var(--color-icon-primary-active))};
          }
        }
      }
    }

    [dir="rtl"] & {
      border-width: 0 0 0 var(--_rating-option-gap);
    }

    &:last-of-type {
      border-width: 0;

      [dir="rtl"] & {
        border-width: 0;
      }
    }
  }

  &__radio {
    display: flex;
    align-items: center;
    justify-content: center;

    &--is-checked {
      #{$this}__icon {
        --icon-color: #{functions.var($element + "-checked-icon", color, var(--color-icon-primary))};
      }
    }
  }

  &__icon {
    --icon-color: #{functions.var($element + "-icon", color, var(--color-icon-secondary))};
  }

  &--is-disabled {
    #{$this}__option {
      cursor: not-allowed;

      @include mixins.hover {
        #{$this}__icon {
          --icon-color: #{functions.var($element + "-hover-icon", color, var(--color-icon-disabled))};
        }

        #{$this}__radio {
          &--is-checked {
            #{$this}__icon {
              --icon-color: #{functions.var($element + "-checked-hover-icon", color, var(--color-icon-disabled))};
            }
          }
        }
      }

      &:active {
        #{$this}__icon {
          --icon-color: #{functions.var($element + "-icon", color, var(--color-icon-disabled))};
        }

        #{$this}__radio {
          &--is-checked {
            #{$this}__icon {
              --icon-color: #{functions.var($element + "-checked-active-icon", color, var(--color-icon-disabled))};
            }
          }
        }
      }
    }

    #{$this}__radio {
      &--is-checked {
        #{$this}__icon {
          --icon-color: #{functions.var($element + "-checked-icon", color, var(--color-icon-disabled))};
        }
      }
    }

    #{$this}__icon {
      --icon-color: #{functions.var($element + "-icon", color, var(--color-icon-disabled))};
    }
  }
}
</style>
